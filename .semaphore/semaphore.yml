version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: CI
    task:
      jobs:
        - name: Build
          parallelism: 100
          commands:
            - date
            - echo "============= START ============"
            - cache list
            - sem-version python 3.7
            - sem-version c 7

            - export PATH=$HOME/.local/bin:$PATH
            - mkdir .pip_cache
            - wget https://raw.githubusercontent.com/zephyrproject-rtos/zephyr/master/scripts/requirements.txt
            - time cache restore
            - time pip3 install --cache-dir .pip_cache -U west
            - time pip3 install --cache-dir .pip_cache -r requirements.txt
            - time cache store

            - sudo mkdir /opt/sdk
            - sudo chown $USER /opt/sdk
            - time cache restore zephyr-sdk-0.10.3 &
            - time cache restore zephyr-module &
            - time cache restore zephyr-tools &
            - time checkout --use-cache &
              # remove man-db since we don't need it and takes time to build the db
            - sudo apt-get remove -y --purge man-db
            - wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add -
            - time sudo apt-add-repository 'deb https://apt.kitware.com/ubuntu/ bionic main'
            - time install-package git cmake ninja-build gperf
              ccache dfu-util device-tree-compiler wget python3-pip python3-setuptools
              python3-wheel xz-utils file make gcc gcc-multilib
            - echo wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.10.3/zephyr-sdk-0.10.3-setup.run
            - echo chmod +x zephyr-sdk-0.10.3-setup.run
            - echo ./zephyr-sdk-0.10.3-setup.run --quiet -- -d /opt/sdk/zephyr-sdk-0.10.3
            - echo cache store zephyr-sdk-0.10.3 /opt/sdk/zephyr-sdk-0.10.3
            - wait
            - echo "============= START-BUILD ============"
            - date
            - cd ${HOME}/${SEMAPHORE_PROJECT_NAME}
            - source .semaphore/docker_run.sh
            - echo "============= END-BUILD ============"
            - date
